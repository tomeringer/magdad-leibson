import socket
from gpiozero import LED

# --- הגדרות חומרה (GPIO BCM) ---
led_red = LED(17)  # GPIO 17 (פין פיזי 11)
led_green = LED(27)  # GPIO 27 (פין פיזי 13)

# --- הגדרות רשת ---
UDP_IP = "0.0.0.0"
UDP_PORT = 4210

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind((UDP_IP, UDP_PORT))

print("========================================")
print(f"Smart Glove Receiver - Listening on {UDP_PORT}")
print("========================================")

try:
    while True:
        data, addr = sock.recvfrom(1024)

        # בדיקה שהחבילה תקינה (Start Byte = 0xAA, End Byte = 0x55)
        if len(data) >= 3 and data[0] == 0xAA and data[2] == 0x55:
            packet_byte = data[1]

            # הדפסת הבייט בפורמט בינארי (8 ביטים) והקסדצימלי
            print(f"Received Byte: 0b{packet_byte:08b} (Hex: 0x{packet_byte:02X})", end=" | ")

            # 1. חילוץ 4 ביטים של Flex (ביטים 4,5,6,7)
            flex_bits = (packet_byte >> 4) & 0x0F

            # 2. חילוץ 2 ביטים של Roll (ביטים 2,3)
            roll_bits = (packet_byte >> 2) & 0x03

            # --- לוגיקה לנורות ---

            # נורה ירוקה: נדלקת רק אם כל 4 החיישנים ב-1 (1111 בבינארי = 15)
            if flex_bits == 0x0F:
                led_green.on()
                print("GREEN: ALL BENT", end=" | ")
            else:
                led_green.off()
                print("GREEN: OFF     ", end=" | ")

            # נורה אדומה: נדלקת אם Roll הוא ימינה (ערך 0b01 = 1)
            if roll_bits == 0b01:
                led_red.on()
                print("RED: ROLL RIGHT")
            else:
                led_red.off()
                print("RED: NO ROLL ")

except KeyboardInterrupt:
    print("\nStopping script...")
finally:
    led_red.off()
    led_green.off()
    sock.close()
